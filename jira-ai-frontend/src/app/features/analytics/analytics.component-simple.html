<div class="analytics-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>Analytics & Insights</h1>
      <p>AI learning metrics and team performance analytics</p>
    </div>
    <div class="header-actions">
      <select 
        class="time-range-select"
        [(ngModel)]="selectedTimeRange"
        (change)="onTimeRangeChange(selectedTimeRange)">
        <option *ngFor="let option of timeRangeOptions" [value]="option.value">
          {{ option.label }}
        </option>
      </select>
      <button class="btn btn-secondary" (click)="refreshData()">
        <i class="fas fa-sync-alt"></i>
        Refresh
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading">
    <i class="fas fa-spinner fa-spin"></i>
    <p>Loading analytics...</p>
  </div>

  <!-- Content -->
  <div class="analytics-content" *ngIf="!isLoading && stats">
    <!-- Quick Stats -->
    <div class="stats-grid">
      <div class="stat-card blue">
        <div class="stat-icon">
          <i class="fas fa-bullseye"></i>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ stats.estimation_accuracy || stats.estimationAccuracy || 0 }}%</span>
          <span class="stat-label">Estimation Accuracy</span>
          <span class="stat-trend positive"><i class="fas fa-arrow-up"></i> 5%</span>
        </div>
      </div>

      <div class="stat-card green">
        <div class="stat-icon">
          <i class="fas fa-user-check"></i>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ stats.assignment_accuracy || stats.assignmentAccuracy || 0 }}%</span>
          <span class="stat-label">Assignment Accuracy</span>
          <span class="stat-trend positive"><i class="fas fa-arrow-up"></i> 3%</span>
        </div>
      </div>

      <div class="stat-card purple">
        <div class="stat-icon">
          <i class="fas fa-layer-group"></i>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ stats.total_stories_created || stats.storiesCreated || 0 }}</span>
          <span class="stat-label">Stories Created</span>
          <span class="stat-trend positive"><i class="fas fa-arrow-up"></i> 12%</span>
        </div>
      </div>

      <div class="stat-card yellow">
        <div class="stat-icon">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ stats.average_completion_time || stats.averageCycleTime || 0 }}</span>
          <span class="stat-label">Avg Cycle Time (days)</span>
          <span class="stat-trend negative"><i class="fas fa-arrow-down"></i> 0.5</span>
        </div>
      </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs-navigation">
      <button 
        *ngFor="let tab of tabs"
        class="tab-btn"
        [class.active]="activeTab === tab.id"
        (click)="setActiveTab(tab.id)">
        <i class="fas" [ngClass]="tab.icon"></i>
        {{ tab.label }}
      </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Overview Tab -->
      <div class="tab-panel" *ngIf="activeTab === 'overview'">
        <div class="overview-grid">
          <!-- Insights Card -->
          <div class="card insights-card">
            <div class="card-header">
              <h3><i class="fas fa-lightbulb"></i> AI Learning Insights</h3>
              <span class="count-badge">{{ insights.length }}</span>
            </div>
            <div class="card-body">
              <div class="insights-list" *ngIf="insights.length > 0">
                <div class="insight-item" *ngFor="let insight of insights" [ngClass]="'insight-' + (insight.color || insight.type)">
                  <div class="insight-icon">
                    <i class="fas" [ngClass]="insight.icon || 'fa-info-circle'"></i>
                  </div>
                  <div class="insight-content">
                    <h4>{{ insight.title }}</h4>
                    <p>{{ insight.description || insight.message }}</p>
                  </div>
                </div>
              </div>
              <div class="empty-state" *ngIf="insights.length === 0">
                <i class="fas fa-lightbulb"></i>
                <p>No insights available yet</p>
              </div>
            </div>
          </div>

          <!-- Recommendations Card -->
          <div class="card recommendations-card">
            <div class="card-header">
              <h3><i class="fas fa-magic"></i> Recommendations</h3>
            </div>
            <div class="card-body">
              <div class="recommendations-list" *ngIf="recommendations.length > 0">
                <div class="recommendation-item" *ngFor="let rec of recommendations">
                  <div class="rec-header">
                    <h4>{{ rec.title }}</h4>
                    <span class="priority-badge" [ngClass]="'priority-' + rec.priority">{{ rec.priority }}</span>
                  </div>
                  <p>{{ rec.description || rec.message }}</p>
                  <div class="rec-details" *ngIf="rec.action || rec.impact">
                    <span class="action-label" *ngIf="rec.action"><strong>Action:</strong> {{ rec.action }}</span>
                    <span class="impact-label" *ngIf="rec.impact"><strong>Impact:</strong> {{ rec.impact }}</span>
                  </div>
                </div>
              </div>
              <div class="empty-state success" *ngIf="recommendations.length === 0">
                <i class="fas fa-check-circle"></i>
                <p>No recommendations at this time</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="card activity-card">
          <div class="card-header">
            <h3><i class="fas fa-history"></i> Recent Activity</h3>
          </div>
          <div class="card-body">
            <div class="activity-list" *ngIf="recentActivity.length > 0">
              <div class="activity-item" *ngFor="let activity of recentActivity">
                <div class="activity-icon" [ngClass]="'icon-' + (activity.color || 'blue')">
                  <i class="fas" [ngClass]="activity.icon || 'fa-circle'"></i>
                </div>
                <div class="activity-content">
                  <h4>{{ activity.title }}</h4>
                  <p>{{ activity.description }}</p>
                  <div class="activity-meta">
                    <span class="user"><i class="fas fa-user"></i> {{ activity.user }}</span>
                    <span class="time"><i class="fas fa-clock"></i> {{ activity.timestamp | date:'short' }}</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="empty-state" *ngIf="recentActivity.length === 0">
              <i class="fas fa-history"></i>
              <p>No recent activity</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Estimation Tab -->
      <div class="tab-panel" *ngIf="activeTab === 'estimation' && estimationAccuracy">
        <div class="detail-grid">
          <div class="card">
            <div class="card-header">
              <h3>Estimation Summary</h3>
            </div>
            <div class="card-body">
              <div class="summary-stats">
                <div class="summary-item">
                  <span class="summary-value">{{ estimationAccuracy.total_estimations || 0 }}</span>
                  <span class="summary-label">Total Estimations</span>
                </div>
                <div class="summary-item success">
                  <span class="summary-value">{{ estimationAccuracy.accurate_estimations || 0 }}</span>
                  <span class="summary-label">Accurate</span>
                </div>
                <div class="summary-item warning">
                  <span class="summary-value">{{ estimationAccuracy.over_estimations || 0 }}</span>
                  <span class="summary-label">Over-estimated</span>
                </div>
                <div class="summary-item danger">
                  <span class="summary-value">{{ estimationAccuracy.under_estimations || 0 }}</span>
                  <span class="summary-label">Under-estimated</span>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3>Accuracy by Complexity</h3>
            </div>
            <div class="card-body">
              <div class="complexity-bars" *ngIf="estimationAccuracy.by_complexity">
                <div class="complexity-item" *ngFor="let item of estimationAccuracy.by_complexity">
                  <div class="complexity-header">
                    <span class="complexity-label">{{ item.complexity }}</span>
                    <span class="complexity-value">{{ item.accuracy }}%</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="item.accuracy" [ngClass]="'complexity-' + item.complexity.toLowerCase()"></div>
                  </div>
                  <span class="complexity-count">{{ item.count }} stories</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Assignment Tab -->
      <div class="tab-panel" *ngIf="activeTab === 'assignment' && assignmentAccuracy">
        <div class="detail-grid">
          <div class="card">
            <div class="card-header">
              <h3>Assignment Summary</h3>
            </div>
            <div class="card-body">
              <div class="summary-stats">
                <div class="summary-item">
                  <span class="summary-value">{{ assignmentAccuracy.total_assignments || 0 }}</span>
                  <span class="summary-label">Total Assignments</span>
                </div>
                <div class="summary-item success">
                  <span class="summary-value">{{ assignmentAccuracy.auto_assigned || 0 }}</span>
                  <span class="summary-label">Auto-assigned</span>
                </div>
                <div class="summary-item warning">
                  <span class="summary-value">{{ assignmentAccuracy.reassignments || 0 }}</span>
                  <span class="summary-label">Reassigned</span>
                </div>
                <div class="summary-item">
                  <span class="summary-value">{{ assignmentAccuracy.average_assignment_score || 0 }}</span>
                  <span class="summary-label">Avg Score</span>
                </div>
              </div>
            </div>
          </div>

          <div class="card full-width" *ngIf="assignmentAccuracy.assignments_by_member && assignmentAccuracy.assignments_by_member.length > 0">
            <div class="card-header">
              <h3>Team Member Performance</h3>
            </div>
            <div class="card-body">
              <div class="member-table">
                <table>
                  <thead>
                    <tr>
                      <th>Member</th>
                      <th>Assigned</th>
                      <th>Completed</th>
                      <th>Reassigned</th>
                      <th>Avg Days</th>
                      <th>Success Rate</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let member of assignmentAccuracy.assignments_by_member">
                      <td>
                        <div class="member-cell">
                          <div class="member-avatar">{{ member.display_name?.charAt(0) || 'U' }}</div>
                          <span>{{ member.display_name }}</span>
                        </div>
                      </td>
                      <td>{{ member.total_assigned }}</td>
                      <td>{{ member.completed }}</td>
                      <td>{{ member.reassigned }}</td>
                      <td>{{ member.average_completion_days }}</td>
                      <td>
                        <span class="success-badge" 
                          [ngClass]="{
                            'high': member.success_rate >= 80,
                            'medium': member.success_rate >= 60 && member.success_rate < 80,
                            'low': member.success_rate < 60
                          }">
                          {{ member.success_rate }}%
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Performance Tab -->
      <div class="tab-panel" *ngIf="activeTab === 'performance'">
        <div class="card">
          <div class="card-header">
            <h3>Performance Metrics</h3>
          </div>
          <div class="card-body">
            <p class="info-message">
              <i class="fas fa-info-circle"></i>
              Performance metrics and charts will be available as more data is collected.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
